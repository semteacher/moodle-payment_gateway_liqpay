{"version":3,"sources":["../src/gateways_modal.js"],"names":["showModalWithPlaceholder","ModalFactory","Templates","render","body","create","modal","show","process","component","paymentArea","itemId","description","console","log","Promise","all","Repository","getConfigForJs","then","liqpayConfig","getRoot","on","ModalEvents","hidden","destroy","switchSdk","resolve","LiqPayCheckout","init","data","signature","embedTo","language","mode","status","outsideClick","e","preventDefault","setBody","markTransactionComplete","orderID","res","hide","success","message","reject","sdkUrl","currentlyloaded","script","document","createElement","readyState","onreadystatechange","onload","setAttribute","head","appendChild"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for LiqPay content in the gateways modal.\n *\n * @module     paygw_liqpay/gateway_modal\n * @copyright  2020 Shamim Rezaie (PayPal) <shamim@moodle.com>\n * @copyright  2021 Andrii Semenets (LiqPay)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport Truncate from 'core/truncate';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => {\n    //switchSdk();\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_liqpay/liqpay_widget_placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\nconsole.log(component);\nconsole.log(paymentArea);\nconsole.log(itemId);\nconsole.log(description);\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([modal, liqpayConfig]) => {\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            // Destroy when hidden.\n            modal.destroy();\n        });\n\n        return Promise.all([\n            modal,\n            liqpayConfig,\n            switchSdk(),\n        ]);\n    })\n    .then(([modal, liqpayConfig]) => {\n        // We have to clear the body. The render method in paypal.Buttons will render everything.\n        //modal.setBody('');\n\n        return new Promise(resolve => {\nconsole.log(liqpayConfig);\n            //window.LiqPayCheckoutCallback = function() {\n            LiqPayCheckout.init({\n                data: \"eyAidmVyc2lvbiIgOiAzLCAicHVibGljX2tleSIgOiAieW91cl9wdWJsaWNfa2V5IiwgImFjdGlv\" +\n                \"biIgOiAicGF5IiwgImFtb3VudCIgOiAxLCAiY3VycmVuY3kiIDogIlVTRCIsICJkZXNjcmlwdGlv\" +\n                \"biIgOiAiZGVzY3JpcHRpb24gdGV4dCIsICJvcmRlcl9pZCIgOiAib3JkZXJfaWRfMSIgfQ==\",\n                signature: \"QvJD5u9Fg55PCx/Hdz6lzWtYwcI=\",\n                embedTo: \"#liqpay_checkout\",\n                language: \"uk\",\n                mode: \"embed\" // embed || popup\n            }).on(\"liqpay.callback\", function(data){\n                console.log(data.status);\n                console.log(data);\n                            modal.getRoot().on(ModalEvents.outsideClick, (e) => {\n                                // Prevent closing the modal when clicking outside of it.\n                                e.preventDefault();\n                            });\n\n                            modal.setBody(getString('authorising', 'paygw_liqpay'));\n\n                            Repository.markTransactionComplete(component, paymentArea, itemId, data.orderID)\n                            .then(res => {\n                                modal.hide();\n                                return res;\n                            })\n                            .then(resolve);\n            }).on(\"liqpay.ready\", function(data){\n                // ready\n            }).on(\"liqpay.close\", function(data){\n                // close\n            });\n            //};\n        });\n    })\n    .then(res => {\n        if (res.success) {\n            return Promise.resolve(res.message);\n        }\n\n        return Promise.reject(res.message);\n    });\n};\n\n/**\n * Unloads the previously loaded LiqPay JavaScript SDK, and loads a new one.\n *\n * @returns {Promise}\n */\nconst switchSdk = async() => {\n    const sdkUrl = `https://static.liqpay.ua/libjs/checkout.js`;\n\n    // Check to see if this file has already been loaded. If so just go straight to the func.\n    if (switchSdk.currentlyloaded === sdkUrl) {\n        return Promise.resolve();\n    }\n\n    const script = document.createElement('script');\n\n    return new Promise(resolve => {\n        if (script.readyState) {\n            script.onreadystatechange = function() {\n                if (this.readyState == 'complete' || this.readyState == 'loaded') {\n                    this.onreadystatechange = null;\n                    resolve();\n                }\n            };\n        } else {\n            script.onload = function() {\n                resolve();\n            };\n        }\n\n        script.setAttribute('src', sdkUrl);\n        document.head.appendChild(script);\n\n        switchSdk.currentlyloaded = sdkUrl;\n    });\n};\n\n/**\n * Holds the full url of loaded PayPal JavaScript SDK.\n *\n * @static\n * @type {string}\n */\nswitchSdk.currentlyloaded = '';\n"],"file":"gateways_modal.min.js"}